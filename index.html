<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>মিনি অ্যাপ — ডেমো (Monetag + Referral)</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#f6f6f6;
      --text:#000000;
      --muted:#666666;
      --accent:#0c78ff;
      --success:#06b6d4;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial, Helvetica, sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    /* Header */
    .header{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--card);border-bottom:1px solid #e0e0e0}
    .avatar{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:18px}
    .user-info{flex:1}
    .user-info small{display:block;color:var(--muted);font-size:12px}
    /* main */
    .main{flex:1;padding:14px 14px 96px}
    .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px}
    .muted{color:var(--muted)}
    .summary{display:flex;gap:10px}
    .summary .item{flex:1;background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.04);text-align:center}
    .amount{font-size:20px;font-weight:700}
    /* pages */
    .page{display:none}
    .page.active{display:block}
    /* ads */
    .ads-list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .ad-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .watch-btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    /* join buttons */
    .join-row{display:flex;gap:8px;margin-top:10px}
    .join-row button{flex:1;padding:8px;border-radius:8px;border:0;background:#0b74ff;color:#fff;font-weight:700;cursor:pointer}
    /* withdraw */
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff;margin-top:8px}
    .submit-btn{padding:10px 14px;border-radius:10px;border:0;background:var(--success);color:#fff;font-weight:700;cursor:pointer;margin-top:10px}
    /* ref box */
    .ref-box{display:flex;gap:8px}
    .copy-btn{padding:8px;border-radius:8px;border:0;background:#0c78ff;color:#fff;font-weight:700;cursor:pointer}
    /* bottom nav */
    .nav{position:fixed;left:10px;right:10px;bottom:12px;height:64px;background:var(--card);border-radius:18px;display:flex;align-items:center;justify-content:space-around;padding:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .nav button{flex:1;margin:0 6px;border:0;padding:8px;border-radius:12px;color:#fff;font-weight:700;cursor:pointer}
    .nav .home{background:#16a34a}
    .nav .earn{background:#0b74ff}
    .nav .withdraw{background:#f97316}
    .nav .profile{background:#7c3aed}
    /* overlay full-white flash */
    .flash { position:fixed; inset:0; background:#fff; display:none; z-index:9999; align-items:center; justify-content:center; color:#000; font-weight:700; }
    /* small */
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>

  <!-- Flash overlay for nav clicks -->
  <div id="flash" class="flash">Loading...</div>

  <!-- Header -->
  <header class="header">
    <div class="avatar" id="avatarEl">?</div>
    <div class="user-info">
      <small id="tgHandle" class="muted">Telegram নাম নেই</small>
      <div id="displayName">অতিথি</div>
    </div>
  </header>

  <!-- Main content -->
  <main class="main">
    <!-- Welcome + summary -->
    <section class="card">
      <div><strong id="welcomeText">স্বাগতম</strong></div>
      <div class="small muted">নিচে আপনার ইনকাম, এড কাউন্ট এবং রেফার কাউন্ট দেখুন</div>
    </section>

    <section class="card summary">
      <div class="item">
        <div class="muted small">টাকা</div>
        <div class="amount" id="balanceAmount">0.00৳</div>
      </div>
      <div class="item">
        <div class="muted small">দেখা এড</div>
        <div class="amount" id="adsCount">0</div>
      </div>
      <div class="item">
        <div class="muted small">রেফারাল</div>
        <div class="amount" id="refCount">0</div>
      </div>
    </section>

    <!-- Pages -->
    <section id="homePage" class="page active card">
      <h3>হোম</h3>
      <p class="small muted">আপনার প্রোফাইলটি উপরে বামে দেখা যাবে।</p>
      <div class="small" style="margin-top:8px">Welcome message: <strong id="welcomeName">অতিথি</strong></div>
    </section>

    <section id="earnPage" class="page card">
      <h3>Earn Rewards</h3>
      <p class="small muted">প্রতি এডে আপনি আয় পাবেন — Monetag zone id বসালে বাস্তব অ্যাড শো হবে।</p>

      <!-- Monetag injection point -->
      <div id="monetagContainer" style="margin-top:10px"></div>

      <!-- Ads list (fallback buttons if monetag not integrated) -->
      <div class="ads-list" id="adsList"></div>

      <div class="card" style="margin-top:12px">
        <h4>টেলিগ্রামে জয়েন করে রিওয়ার্ড</h4>
        <div class="join-row">
          <button id="joinBtn1">জয়েন ১</button>
          <button id="joinBtn2">জয়েন ২</button>
          <button id="joinBtn3">জয়েন ৩</button>
        </div>
        <div class="small muted" style="margin-top:8px">জয়েন বাটনে ক্লিক করলে টেলিগ্রামে চ্যানেল খুলবে — কনফার্ম করলে বোনাস।</div>
      </div>
    </section>

    <section id="withdrawPage" class="page card">
      <h3>Withdraw</h3>
      <div class="small muted">আপনার ব্যালান্স: <strong id="withdrawBalance">0.00৳</strong></div>

      <div style="margin-top:12px">
        <label class="small muted">পেমেন্ট মেথড</label>
        <select id="payMethod">
          <option value="">Select method</option>
          <option value="bkash">bKash</option>
          <option value="nagad">Nagad</option>
          <option value="rocket">Rocket</option>
          <option value="bank">Bank Transfer</option>
          <option value="other">Other</option>
        </select>

        <div id="methodFields"></div>

        <label class="small muted" style="margin-top:10px">রিকোয়েস্ট এমাউন্ট (৳)</label>
        <input type="number" id="withdrawAmount" placeholder="Amount to withdraw" />

        <button class="submit-btn" id="requestWithdraw">উইথড্র রিকোয়েস্ট পাঠান</button>
        <div class="small muted" style="margin-top:8px">নোট: রিয়েল সেটআপে অ্যাডমিন Telegram বট থেকে রিকোয়েস্ট পাবেন।</div>
      </div>
    </section>

    <section id="profilePage" class="page card">
      <h3>প্রোফাইল</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="avatar" id="profileAvatar">?</div>
        <div>
          <div id="profileName">অতিথি</div>
          <div class="small muted" id="profileUsername">@username</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small muted">ব্যালান্স: <strong id="profileBalance">0.00৳</strong></div>
        <div class="small muted">এড দেখা: <strong id="profileAds">0</strong></div>
        <div class="small muted">রেফার: <strong id="profileRef">0</strong></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h4>রেফার লিংক</h4>
        <div class="ref-box">
          <input id="refLink" readonly style="padding:8px;border-radius:8px;border:1px solid #ddd;flex:1" />
          <button class="copy-btn" id="copyRef">কপি</button>
        </div>
        <div class="small muted" style="margin-top:8px">আপনার শেয়ার করা লিংকে কেউ Start করলে আপনি রেফার বোনাস পাবেন।</div>
      </div>
    </section>

  </main>

  <!-- Bottom nav -->
  <nav class="nav">
    <button class="home" id="navHome">Home</button>
    <button class="earn" id="navEarn">Earn</button>
    <button class="withdraw" id="navWithdraw">Withdraw</button>
    <button class="profile" id="navProfile">Profile</button>
  </nav>

<script>
 
/* ===========================
   CONFIG (change these)
   =========================== */
const CONFIG = {
  PER_AD_AMOUNT: 0.5,         // প্রতি অ্যাডে কত টাকা
  DAILY_AD_LIMIT: 10,         // প্রতিদিন মোট এড লিমিট
  REFERRAL_REWARD: 10,        // রেফার বোনাস (টাকা)
  MONETAG_ZONE_ID: '9717419', // Monetag zone ID এখানে বসান
  // Telegram Bot token & admin chat id (you provided)
  BOT_TOKEN: '7567052001:AAHrSf6mQPzIsI-_h-zHbYPPaoxO1OMZSH0',
  ADMIN_CHAT_ID: '6750565670',
  BOT_USERNAME: 'MonetagMiniBot_bot' // bot username without @
};

/* ===========================
   Storage keys & user model
   =========================== */
const STORAGE_KEY = 'miniapp_user_v2'; // stores current user object
const USER_BY_ID_PREFIX = 'miniapp_user_id_'; // store user by id for referral credit

// Try to detect Telegram WebApp user (if inside Telegram WebApp)
// If not available, fallback to a generated local user id.
function detectTelegramUser() {
  try {
    const tgInit = window?.Telegram?.WebApp?.initDataUnsafe?.user || null;
    if (tgInit && tgInit.id) {
      return {
        id: 'tg_' + String(tgInit.id),
        first_name: tgInit.first_name || (tgInit.username || 'User'),
        username: tgInit.username || '',
        isTelegram: true
      };
    }
  } catch(e) {
    // ignore
  }
  // fallback local user
  const localId = localStorage.getItem('miniapp_local_id') || ('local_' + Math.random().toString(36).slice(2,9));
  localStorage.setItem('miniapp_local_id', localId);
  return { id: localId, first_name: 'অতিথি', username: '', isTelegram:false };
}

// Load or create current user object
function loadUser(){
  const base = detectTelegramUser();
  let stored = localStorage.getItem(STORAGE_KEY);
  if(stored){
    try { const parsed = JSON.parse(stored); 
      // if stored id mismatches current (e.g., different Telegram user) create new
      if(parsed.id && parsed.id !== base.id){
        // keep separate per-id storage; create new user from base
        return createAndSaveUser(base);
      }
      return parsed;
    } catch(e){}
  }
  return createAndSaveUser(base);
}
function createAndSaveUser(base){
  const u = {
    id: base.id,
    first_name: base.first_name || 'অতিথি',
    username: base.username || '',
    balance: 0,
    adsWatchedTotal: 0,
    adsWatchedToday: 0,
    adsWatchedDate: null,
    referrals: 0,
    referrer: null,
    creditedRef: false // whether this user has credited their referrer already
  };
  saveUser(u);
  // also save per-id record for referrals
  localStorage.setItem(USER_BY_ID_PREFIX + u.id, JSON.stringify(u));
  return u;
}
function saveUser(u){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(u));
  // keep per-id copy so referrer can be credited by id
  localStorage.setItem(USER_BY_ID_PREFIX + u.id, JSON.stringify(u));
}

/* ===========================
   Initialize user & referral param
   =========================== */
let user = loadUser();

// parse URL for ref param (supports both ?ref=ID and ?startapp=ID (telegram startapp))
function getQueryParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
const incomingRef = getQueryParam('ref') || getQueryParam('start') || getQueryParam('startapp');

/* ===========================
   Referral credit logic
   - If incomingRef exists and current user hasn't credited yet:
     - Try to load referrer by id from localStorage (USER_BY_ID_PREFIX + incomingRef)
     - If found, add REFERRAL_REWARD to referrer's balance and increment referrals
     - If not found, create a minimal referrer record and credit it (so the sharer sees credit if they later open same browser)
   - Mark current user as creditedRef to avoid double-crediting
   NOTE: This local-only approach works reliably when referrer has a saved record in the same browser.
   For cross-device reliability, use a server-side DB and notify server/bot to credit.
   =========================== */
function tryCreditReferral(){
  if(!incomingRef) return;
  if(user.creditedRef) return; // already credited for this user
  // don't credit if incomingRef equals current user's id
  if(incomingRef === user.id) return;
  // Load referrer record
  let refRaw = localStorage.getItem(USER_BY_ID_PREFIX + incomingRef);
  let refUser;
  if(refRaw){
    try { refUser = JSON.parse(refRaw); } catch(e){ refUser = null; }
  }
  if(!refUser){
    // create minimal ref user record so it can be credited locally
    refUser = { id: incomingRef, first_name: 'Referrer', username:'', balance:0, adsWatchedTotal:0, referrals:0, referrer:null };
  }
  // credit the referrer
  refUser.balance = (refUser.balance || 0) + CONFIG.REFERRAL_REWARD;
  refUser.referrals = (refUser.referrals || 0) + 1;
  // save back
  localStorage.setItem(USER_BY_ID_PREFIX + refUser.id, JSON.stringify(refUser));

  // mark current user as having credited their referrer (so they can't re-credit)
  user.referrer = refUser.id;
  user.creditedRef = true;
  saveUser(user);

  // if the referrer is the current browser's user (i.e., same client), update visible ref count & balance
  if(refUser.id === user.id){ /* shouldn't normally happen */ }

  // Notify (UI)
  alert('রেফারাল নিশ্চিত হয়েছে — রেফারারকে বোনাস যোগ করা হয়েছে।');
}

/* ===========================
   Render functions
   =========================== */
function renderHeader(){
  document.getElementById('displayName').innerText = user.first_name || 'অতিথি';
  document.getElementById('profileName').innerText = user.first_name || 'অতিথি';
  document.getElementById('profileUsername').innerText = user.username ? ('@'+user.username) : '@username';
  document.getElementById('avatarEl').innerText = (user.first_name && user.first_name[0]) ? user.first_name[0] : '?';
  document.getElementById('profileAvatar').innerText = (user.first_name && user.first_name[0]) ? user.first_name[0] : '?';
}
function renderSummary(){
  document.getElementById('balanceAmount').innerText = (user.balance || 0).toFixed(2) + '৳';
  document.getElementById('adsCount').innerText = user.adsWatchedTotal || 0;
  document.getElementById('refCount').innerText = user.referrals || 0;
  document.getElementById('withdrawBalance').innerText = (user.balance || 0).toFixed(2) + '৳';
  document.getElementById('profileBalance').innerText = (user.balance || 0).toFixed(2) + '৳';
  document.getElementById('profileAds').innerText = user.adsWatchedTotal || 0;
  document.getElementById('profileRef').innerText = user.referrals || 0;
  document.getElementById('welcomeText').innerText = 'স্বাগতম ' + (user.first_name || 'অতিথি');
  // referral link (uses user.id)
  const base = window.location.origin + window.location.pathname;
  document.getElementById('refLink').value = base + '?ref=' + user.id;
}

/* ===========================
   Monetag Injection (if provided)
   =========================== */
function injectMonetag(){
  const c = document.getElementById('monetagContainer');
  c.innerHTML = '';
  if(CONFIG.MONETAG_ZONE_ID && CONFIG.MONETAG_ZONE_ID !== '9717419){
    // Insert Monetag script tag (document.write inside string avoided)
    const script = document.createElement('script');
    // NOTE: actual monetag src pattern may vary — replace with the correct script url Monetag provides
    script.src = `https://a.monetag.com/${CONFIG.MONETAG_ZONE_ID}.js`;
    script.async = true;
    c.appendChild(script);
  } else {
    // show fallback info
    const info = document.createElement('div');
    info.className = 'small muted';
    info.innerText = 'Monetag zoneId বসান হলে এখানে অ্যাড শো হবে (CONFIG.MONETAG_ZONE_ID)।';
    c.appendChild(info);
  }
}

/* ===========================
   Build simple ad list (fallback buttons)
   =========================== */
function renderAdsList(){
  const list = document.getElementById('adsList');
  list.innerHTML = '';
  for(let i=1;i<=3;i++){
    const el = document.createElement('div');
    el.className = 'ad-card';
    el.innerHTML = `<div>
      <div style="font-weight:700">Ad Slot ${i}</div>
      <div class="small muted">প্রতি এড আয়: ${CONFIG.PER_AD_AMOUNT}৳ — আজ দেখেছেন: ${user.adsWatchedToday || 0}</div>
    </div>
    <div><button class="watch-btn" data-ad="${i}">Watch</button></div>`;
    list.appendChild(el);
  }
  // attach handlers
  list.querySelectorAll('.watch-btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      await handleWatchAd();
    });
  });
}

/* ===========================
   Watch Ad logic (simulated)
   =========================== */
async function handleWatchAd(){
  resetDailyIfNeeded();
  if(user.adsWatchedToday >= CONFIG.DAILY_AD_LIMIT){
    alert('আপনি আজকের লিমিট শেষ করে ফেলেছেন।');
    return;
  }
  // show flash (simulate)
  showFlash('Watching ad...');
  // simulate 8 seconds watch
  await new Promise(r=>setTimeout(r, 8000));
  // award
  user.adsWatchedToday = (user.adsWatchedToday || 0) + 1;
  user.adsWatchedTotal = (user.adsWatchedTotal || 0) + 1;
  user.balance = (user.balance || 0) + CONFIG.PER_AD_AMOUNT;
  saveUser(user);
  hideFlash();
  alert('ধন্যবাদ! এড দেখার জন্য ' + CONFIG.PER_AD_AMOUNT + '৳ পাওয়া হয়েছে।');
  renderAll();
}

/* ===========================
   Join Telegram buttons (open link and give small bonus)
   =========================== */
function setupJoinButtons(){
  const channels = [
    'https://t.me/dailyEernTaskBot',
    'https://t.me/example_channel_2',
    'https://t.me/example_channel_3'
  ];
  document.getElementById('joinBtn1').addEventListener('click', ()=>{
    window.open(channels[0],'_blank');
    // small delay then reward (demo)
    setTimeout(()=>{ user.balance += CONFIG.PER_AD_AMOUNT; saveUser(user); alert('Join confirmed (demo). Bonus added.'); renderAll(); },1500);
  });
  document.getElementById('joinBtn2').addEventListener('click', ()=>{
    window.open(channels[1],'_blank');
    setTimeout(()=>{ user.balance += CONFIG.PER_AD_AMOUNT; saveUser(user); alert('Join confirmed (demo). Bonus added.'); renderAll(); },1500);
  });
  document.getElementById('joinBtn3').addEventListener('click', ()=>{
    window.open(channels[2],'_blank');
    setTimeout(()=>{ user.balance += CONFIG.PER_AD_AMOUNT; saveUser(user); alert('Join confirmed (demo). Bonus added.'); renderAll(); },1500);
  });
}

/* ===========================
   Withdraw form handling
   - builds method fields dynamically
   - sends withdraw request to admin via Telegram bot (fetch)
   =========================== */
document.getElementById('payMethod').addEventListener('change', function(){
  const container = document.getElementById('methodFields');
  container.innerHTML = '';
  const v = this.value;
  if(!v) return;
  if(v === 'bank'){
    container.innerHTML = `<input id="methodInput" placeholder="Bank name / Account no" />`;
  } else {
    container.innerHTML = `<input id="methodInput" placeholder="নাম/মোবাইল নম্বর (e.g., 01XXXXXXXXX)" />`;
  }
});

document.getElementById('requestWithdraw').addEventListener('click', async function(){
  const amt = Number(document.getElementById('withdrawAmount').value || 0);
  const method = document.getElementById('payMethod').value;
  const details = document.getElementById('methodInput') ? document.getElementById('methodInput').value.trim() : '';
  if(!method){ alert('পেমেন্ট মেথড নির্বাচন করুন'); return; }
  if(!details){ alert('পেমেন্ট ডিটেইলস দিন'); return; }
  if(!amt || amt < 1){ alert('সঠিক পরিমান লিখুন'); return; }
  if(amt > user.balance){ alert('আপনার ব্যালান্স পর্যাপ্ত নয়'); return; }
  // deduct locally (demo)
  user.balance = (user.balance || 0) - amt;
  saveUser(user);
  renderAll();
  alert('উইথড্র রিকোয়েস্ট পাঠানো হয়েছে (ডেমো)। অ্যাডমিন চেক করবেন।');

  // Send withdraw request to admin via Telegram Bot
  if(CONFIG.BOT_TOKEN && CONFIG.ADMIN_CHAT_ID){
    const api = `https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`;
    const text = `New Withdraw Request\nUser: ${user.first_name} (id: ${user.id})\nAmount: ${amt}৳\nMethod: ${method}\nDetails: ${details}`;
    try{
      await fetch(api, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ chat_id: CONFIG.ADMIN_CHAT_ID, text })
      });
    } catch(e){
      console.warn('Telegram notify failed', e);
    }
  }
});

/* ===========================
   Copy referral link
   =========================== */
document.getElementById('copyRef').addEventListener('click', function(){
  const el = document.getElementById('refLink');
  el.select();
  document.execCommand('copy');
  alert('রেফার লিংক কপি হয়েছে।');
});

/* ===========================
   Navigation and flash
   =========================== */
function showFlash(txt){
  const f = document.getElementById('flash');
  f.innerText = txt || 'Loading...';
  f.style.display = 'flex';
}
function hideFlash(){ document.getElementById('flash').style.display = 'none'; }

/* show page with quick white flash (as requested: whole screen white and black text) */
function gotoPage(pageId){
  // show flash
  showFlash('Loading...');
  // ensure nav highlight
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  if(pageId === 'homePage') document.getElementById('navHome').classList.add('active');
  if(pageId === 'earnPage') document.getElementById('navEarn').classList.add('active');
  if(pageId === 'withdrawPage') document.getElementById('navWithdraw').classList.add('active');
  if(pageId === 'profilePage') document.getElementById('navProfile').classList.add('active');

  setTimeout(()=>{
    // switch pages
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    // hide flash
    hideFlash();
  }, 250); // 250ms flash
}

// attach nav
document.getElementById('navHome').addEventListener('click', ()=>gotoPage('homePage'));
document.getElementById('navEarn').addEventListener('click', ()=>gotoPage('earnPage'));
document.getElementById('navWithdraw').addEventListener('click', ()=>gotoPage('withdrawPage'));
document.getElementById('navProfile').addEventListener('click', ()=>gotoPage('profilePage'));

/* ===========================
   Daily reset helper
   =========================== */
function resetDailyIfNeeded(){
  const today = new Date().toDateString();
  if(user.adsWatchedDate !== today){
    user.adsWatchedToday = 0;
    user.adsWatchedDate = today;
    saveUser(user);
  }
}

/* ===========================
   Render all
   =========================== */
function renderAll(){
  resetDailyIfNeeded();
  renderHeader();
  renderSummary();
  renderAdsList();
  injectMonetag();
}
renderAll();

/* ===========================
   When page first loads: credit referral if any and not credited
   =========================== */
(function onLoadReferral(){
  if(incomingRef){
    // show overlay prompting to Start (so user must confirm)
    const confirmed = confirm('আপনি রেফারাল লিংক থেকে এসেছেন। শুরু করতে চান? (Start করলে রেফারারকে ক্রেডিট করা হবে)');
    if(confirmed){
      // only credit once per user
      tryCreditReferral();
    } else {
      // user cancelled; do nothing
    }
  }
})();

/* ===========================
   Utility: expose some functions to console for debugging
   =========================== */
window._miniapp = {
  user,
  saveUser,
  tryCreditReferral,
  gotoPage,
  renderAll
};

</script>
</body>
  </html>

<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>মিনি অ্যাপ — ডেমো</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#98a0b3;
      --accent: #06b6d4;
      --glass: rgba(255,255,255,0.03);
      --btn-radius: 12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family: 'Segoe UI', Roboto, Arial, sans-serif;background:linear-gradient(180deg,#071024 0%, #0f1724 100%);color:#e6eef8;min-height:100vh;display:flex;flex-direction:column}

    /* Header */
    .header{display:flex;align-items:center;gap:12px;padding:12px 14px}
    .avatar{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,#334155,#0ea5a4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:18px}
    .user-info{flex:1}
    .user-info small{display:block;color:var(--muted);font-size:12px}
    .welcome{padding:12px 14px}
    .card{background:var(--card);border-radius:14px;padding:12px;margin:12px}

    /* Summary */
    .summary{display:flex;gap:10px;justify-content:space-between}
    .summary .item{flex:1;background:var(--glass);padding:12px;border-radius:10px;text-align:center}
    .amount{font-size:20px;font-weight:700}

    /* Main area */
    .main{flex:1;padding-bottom:86px}

    /* Bottom Navigation */
    .nav{position:fixed;left:10px;right:10px;bottom:12px;height:62px;background:rgba(2,6,23,0.65);backdrop-filter:blur(6px);border-radius:18px;display:flex;align-items:center;justify-content:space-around;padding:8px}
    .nav button{flex:1;margin:0 6px;border:0;padding:10px;border-radius:12px;color:#fff;font-weight:700;cursor:pointer}
    .nav button:active{transform:translateY(2px)}

    /* unique colors for each nav button */
    .nav .home-btn{background:#1fa54a} /* green */
    .nav .earn-btn{background:#0c78ff} /* blue */
    .nav .withdraw-btn{background:#ff8a00} /* orange */
    .nav .profile-btn{background:#8b5cf6} /* purple */

    /* Page containers */
    .page{display:none;padding:12px}
    .page.active{display:block}

    /* Earn page */
    .ads-list{display:flex;flex-direction:column;gap:10px}
    .ad-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
    .ad-meta{font-size:13px;color:var(--muted)}
    .watch-btn{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:10px;border:0;font-weight:700}

    /* Withdraw form */
    .form-row{display:flex;flex-direction:column;margin-bottom:10px}
    input,select,textarea{padding:10px;border-radius:10px;border:0;background:#091024;color:#e6eef8}
    .submit-btn{padding:10px;border-radius:12px;border:0;font-weight:700}

    /* small helpers */
    .muted{color:var(--muted)}
    .right{float:right}

    /* referral box */
    .ref-box{display:flex;gap:8px;align-items:center}
    .copy-btn{padding:8px;border-radius:8px;border:0;background:#065f46;color:#fff;font-weight:700}

    /* overlay */
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.7);display:flex;align-items:center;justify-content:center}
    .overlay .modal{background:#071428;padding:18px;border-radius:12px;max-width:420px;width:92%}

    .small{font-size:12px}

    /* responsive tweaks */
    @media(min-width:720px){.header{padding:18px 28px}.card{margin:18px auto;max-width:720px}}
  </style>
</head>
<body>

  <!-- Header with avatar and name (top-left corner) -->
  <header class="header">
    <div class="avatar" id="avatarEl">?</div>
    <div class="user-info">
      <small id="tgHandle" class="muted">লগইন করুন</small>
      <div id="displayName">অতিথি</div>
    </div>
  </header>

  <main class="main">

    <!-- Welcome -->
    <section class="welcome">
      <div class="card">
        <div><strong id="welcomeText">স্বাগতম</strong></div>
        <div class="muted small">আপনি এখানে ইনকাম শুরু করতে পারেন</div>
      </div>

      <!-- Summary: income, ads, referrals -->
      <div class="card summary">
        <div class="item">
          <div class="muted small">টাকা</div>
          <div class="amount" id="balanceAmount">0.00৳</div>
        </div>
        <div class="item">
          <div class="muted small">দেখা এড</div>
          <div class="amount" id="adsCount">0</div>
        </div>
        <div class="item">
          <div class="muted small">রেফারাল</div>
          <div class="amount" id="refCount">0</div>
        </div>
      </div>

    </section>

    <!-- Pages -->
    <section id="homePage" class="page active">
      <div class="card">
        <h3>হোম</h3>
        <p class="muted small">নিচের বাটন থেকে অন্য ফিচার এ যান — Earn, Withdraw, Profile</p>
      </div>
    </section>

    <section id="earnPage" class="page">
      <div class="card">
        <h3>Earn Rewards</h3>
        <p class="muted small">প্রতি এডে ইনকাম দেখুন এবং প্রতিদিনের লিমিট আছে</p>

        <div class="ads-list" id="adsList">
          <!-- ad cards injected by JS -->
        </div>

        <div style="height:8px"></div>

        <div class="card">
          <h4>টেলিগ্রামে জয়েন করে রিওয়ার্ড</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="watch-btn" id="joinBtn1">জয়েন ১ (পয়েন্ট পাবে)</button>
            <button class="watch-btn" id="joinBtn2">জয়েন ২ (পয়েন্ট পাবে)</button>
            <button class="watch-btn" id="joinBtn3">জয়েন ৩ (পয়েন্ট পাবে)</button>
          </div>
          <div class="muted small">নোট: জয়েন বাটনে ক্লিক করলে নতুন ট্যাবে টেলিগ্রাম লিংক খুলবে; তারপর কনফার্ম করলে পয়েন্ট যোগ হবে।</div>
        </div>

      </div>
    </section>

    <section id="withdrawPage" class="page">
      <div class="card">
        <h3>Withdrawal</h3>
        <p class="muted small">আপনার ব্যালান্স অনুযায়ী উইথড্র করতে পারবেন</p>

        <div class="form-row">
          <label class="muted small">বর্তমান ব্যালান্স</label>
          <div id="withdrawBalance">0.00৳</div>
        </div>

        <div class="form-row">
          <label class="muted small">পেমেন্ট মেথড</label>
          <select id="payMethod">
            <option value="bkash">bKash</option>
            <option value="nagad">Nagad</option>
            <option value="rocket">Rocket</option>
            <option value="bank">Bank Transfer</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-row" id="methodFields">
          <!-- dynamic fields appear here -->
        </div>

        <div class="form-row">
          <label class="muted small">রিকোয়েস্ট এমাউন্ট (৳)</label>
          <input type="number" id="withdrawAmount" placeholder="পরিমাণ লিখুন" />
        </div>

        <button class="submit-btn" id="requestWithdraw">উইথড্র রিকোয়েস্ট পাঠান</button>

        <div class="muted small" style="margin-top:8px">নোট: এই ডেমোতে রিকোয়েস্ট লোকাল স্টোরেজ এ জমা হবে। বাস্তব অ্যাপ এডমিনকে Telegram বট থেকে পাঠানো যাবে (নীচে নির্দেশনা)।</div>

      </div>
    </section>

    <section id="profilePage" class="page">
      <div class="card">
        <h3>প্রোফাইল</h3>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="avatar" id="profileAvatar">?</div>
          <div>
            <div id="profileName">অতিথি</div>
            <div class="muted small" id="profileUsername">@username</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="muted small">ইনকাম (টাকা)</div>
          <div id="profileBalance" style="font-weight:700">0.00৳</div>
          <div class="muted small">এড দেখা: <span id="profileAds">0</span></div>
          <div class="muted small">রেফার: <span id="profileRef">0</span></div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h4>রেফার লিংক</h4>
          <div class="ref-box">
            <input id="refLink" readonly style="flex:1;padding:8px;border-radius:8px;border:0;background:#071328;color:#cfeffd" />
            <button class="copy-btn" id="copyRef">কপি</button>
          </div>
          <div class="muted small">যার শেয়ার করবে, যদি সে স্টার্ট বাটনে চাপ দিলে আপনি পয়েন্ট/টাকা পাবেন (অ্যাডমিন সেট করে)।</div>
        </div>

      </div>
    </section>

  </main>

  <!-- Bottom Navigation -->
  <nav class="nav">
    <button class="home-btn" id="navHome">Home</button>
    <button class="earn-btn" id="navEarn">Earn</button>
    <button class="withdraw-btn" id="navWithdraw">Withdraw</button>
    <button class="profile-btn" id="navProfile">Profile</button>
  </nav>

  <!-- Overlay for referral start or ask name if not inside Telegram -->
  <div id="overlay" class="overlay" style="display:none">
    <div class="modal">
      <h3 id="overlayTitle">শুরু করুন</h3>
      <p class="muted small" id="overlayText">নিচের বাটনে চাপ দিয়ে শুরু করুন</p>
      <div style="height:8px"></div>
      <button id="startBtn" class="submit-btn">Start</button>
      <div style="height:8px"></div>
      <div class="muted small">উল্লেখ্য: রেফারাল পদ্ধতি সম্পূর্ণ কাজের জন্য সার্ভার/বট প্রয়োজন। এখানে ডেমো লোকাল-সিমুলেশন।</div>
    </div>
  </div>

  <script>
    /**********************
     * Configuration (change as needed)
     **********************/
    const CONFIG = {
      DAILY_AD_LIMIT: 10,
      PER_AD_AMOUNT: 0.5, // in ৳ per ad (changeable)
      MIN_WITHDRAW: 50,
      REFERRAL_REWARD: 10, // reward given on successful referral (demo)
      TELEGRAM_CHANNELS: [
        'https://t.me/yourchannel1',
        'https://t.me/yourchannel2',
        'https://t.me/yourchannel3'
      ]
      // To send withdraws to admin via Telegram bot you can add BOT_TOKEN and ADMIN_CHAT_ID below
      // BOT_TOKEN: '', ADMIN_CHAT_ID: ''
    };

    /**********************
     * Helper: local storage user
     **********************/
    const STORAGE_KEY = 'miniapp_user_v1';
    const REQUESTS_KEY = 'miniapp_withdraws_v1';

    function loadUser(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);
      // default guest user
      const newUser = {
        id: 'user_' + Math.random().toString(36).slice(2,9),
        first_name: 'অতিথি',
        username: '',
        avatar: '',
        balance: 0,
        adsWatchedTotal: 0,
        adsWatchedToday: 0,
        adsWatchedDate: null,
        referrals: 0,
        referrer: null
      };
      saveUser(newUser);
      return newUser;
    }
    function saveUser(u){ localStorage.setItem(STORAGE_KEY, JSON.stringify(u)); }

    let user = loadUser();

    /**********************
     * Try to detect Telegram WebApp user (if opened inside Telegram)
     **********************/
    function tryTelegramUser(){
      try{
        const tg = window?.Telegram?.WebApp?.initDataUnsafe?.user || window?.Telegram?.WebApp?.initDataUnsafe;
        if(tg && tg.first_name){
          // merge into user
          user.first_name = tg.first_name + (tg.last_name ? (' ' + tg.last_name) : '');
          user.username = tg.username || '';
          // avatar not provided usually by WebApp initData — keep blank
          saveUser(user);
        }
      }catch(e){ console.warn('No Telegram WebApp info', e); }
    }

    // On load: parse URL for ref param
    function getQueryParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const incomingRef = getQueryParam('ref');
    let showStartOverlay = false;
    if(incomingRef && !localStorage.getItem('miniapp_started')){
      showStartOverlay = true;
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('overlayTitle').innerText = 'রেফারাল লিংক থেকে এসেছেন';
      document.getElementById('overlayText').innerText = 'স্টার্ট বাটনে চাপলে আপনার অ্যাকাউন্ট তৈরি হবে এবং রেফারারকে রিওয়ার্ড জানানোর অনুরোধ যাবে (ডেমো)।';
    }

    document.getElementById('startBtn').addEventListener('click', ()=>{
      // mark started and set referrer in local user
      localStorage.setItem('miniapp_started', '1');
      if(incomingRef){
        user.referrer = incomingRef;
        // In a real app: we would notify server or bot to credit incomingRef
        // For demo: if the referrer exists in this browser storage, credit them
        const refUserRaw = localStorage.getItem(STORAGE_KEY + '_' + incomingRef);
        if(refUserRaw){
          const refUser = JSON.parse(refUserRaw);
          refUser.referrals = (refUser.referrals || 0) + 1;
          refUser.balance = (refUser.balance || 0) + CONFIG.REFERRAL_REWARD;
          localStorage.setItem(STORAGE_KEY + '_' + incomingRef, JSON.stringify(refUser));
        }
      }
      saveUser(user);
      document.getElementById('overlay').style.display = 'none';
      renderAll();
    });

    /**********************
     * Rendering functions
     **********************/
    function renderHeader(){
      document.getElementById('displayName').innerText = user.first_name || 'অতিথি';
      document.getElementById('tgHandle').innerText = user.username ? ('@' + user.username) : 'Telegram নাম নেই';
      const av = document.getElementById('avatarEl');
      const pAv = document.getElementById('profileAvatar');
      const initial = (user.first_name || 'অত')[0] || '?';
      av.innerText = initial;
      pAv.innerText = initial;
    }

    function renderSummary(){
      document.getElementById('balanceAmount').innerText = (user.balance || 0).toFixed(2) + '৳';
      document.getElementById('adsCount').innerText = user.adsWatchedTotal || 0;
      document.getElementById('refCount').innerText = user.referrals || 0;
    }

    function renderHome(){
      // nothing extra for now
    }

    const adTemplates = [
      {id:'ad1', title:'সাহায্য ভিডিও দেখুন', daily: CONFIG.DAILY_AD_LIMIT, per: CONFIG.PER_AD_AMOUNT},
      {id:'ad2', title:'অ্যাপ প্রোমো দেখুন', daily: CONFIG.DAILY_AD_LIMIT, per: CONFIG.PER_AD_AMOUNT},
    ];

    function resetDailyIfNeeded(){
      const today = new Date().toDateString();
      if(user.adsWatchedDate !== today){
        user.adsWatchedToday = 0;
        user.adsWatchedDate = today;
        saveUser(user);
      }
    }

    function renderEarn(){
      resetDailyIfNeeded();
      const list = document.getElementById('adsList');
      list.innerHTML = '';
      adTemplates.forEach(ad=>{
        const div = document.createElement('div');
        div.className = 'ad-card';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">${ad.title}</div>
              <div class="ad-meta">প্রতিদিন লিমিট: ${ad.daily} — আপনি আজ দেখেছেন: ${user.adsWatchedToday}</div>
            </div>
            <div style="text-align:right">
              <div class="ad-meta">প্রতি এড: ${ad.per}৳</div>
              <button class="watch-btn" data-ad="${ad.id}">Watch</button>
            </div>
          </div>
        `;
        list.appendChild(div);
      });

      // attach handlers
      document.querySelectorAll('[data-ad]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const adId = e.currentTarget.dataset.ad;
          await watchAd(adId);
          renderAll();
        });
      });

      // join buttons
      document.getElementById('joinBtn1').onclick = ()=> openAndClaim(0);
      document.getElementById('joinBtn2').onclick = ()=> openAndClaim(1);
      document.getElementById('joinBtn3').onclick = ()=> openAndClaim(2);
    }

    async function watchAd(adId){
      resetDailyIfNeeded();
      if(user.adsWatchedToday >= CONFIG.DAILY_AD_LIMIT){
        alert('আপনি আজকের লিমিট শেষ করে ফেলেছেন।');
        return;
      }
      // Simulate watching ad
      const watching = confirm('এড দেখা শুরু করতে চান? (ডেমো — OK চাপলে 10 সেকেন্ড সিমুলেশন)');
      if(!watching) return;
      const seconds = 10;
      for(let i=seconds;i>0;i--){
        await new Promise(r=>setTimeout(r,1000));
      }
      // after watching
      user.adsWatchedToday = (user.adsWatchedToday || 0) + 1;
      user.adsWatchedTotal = (user.adsWatchedTotal || 0) + 1;
      user.balance = (user.balance || 0) + CONFIG.PER_AD_AMOUNT;
      saveUser(user);
      alert('ধন্যবাদ! এড দেখার জন্য আপনি ' + CONFIG.PER_AD_AMOUNT + '৳ পেয়েছেন।');
    }

    function openAndClaim(idx){
      const url = CONFIG.TELEGRAM_CHANNELS[idx] || '#';
      window.open(url, '_blank');
      // For demo we give a small instruction to claim
      setTimeout(()=>{
        const claim = confirm('ক্লেইম করতে চান? আপনি কনফার্ম করলে পয়েন্ট যোগ হবে (ডেমো)');
        if(claim){
          user.balance = (user.balance || 0) + 1; // demo reward
          saveUser(user);
          renderAll();
          alert('ধন্যবাদ! পয়েন্ট যোগ করা হয়েছে (ডেমো: 1৳)।');
        }
      }, 1500);
    }

    function renderWithdraw(){
      document.getElementById('withdrawBalance').innerText = (user.balance || 0).toFixed(2) + '৳';
      // method fields initial
      renderMethodFields();
    }

    function renderMethodFields(){
      const container = document.getElementById('methodFields');
      container.innerHTML = '';
      const method = document.getElementById('payMethod').value;
      if(method === 'bank'){
        container.innerHTML = `<input id="bankName" placeholder="ব্যাংকের নাম" /><input id="bankAcc" placeholder="অ্যাকাউন্ট নং/IBAN" />`;
      } else if(method === 'other'){
        container.innerHTML = `<input id="otherName" placeholder="নাম/অ্যাকাউন্ট" />`;
      } else {
        container.innerHTML = `<input id="mobileNo" placeholder="নাম/নম্বর (যেমন: 01XXXXXXXXX)" />`;
      }
    }

    document.getElementById('payMethod').addEventListener('change', renderMethodFields);

    document.getElementById('requestWithdraw').addEventListener('click', ()=>{
      const amount = Number(document.getElementById('withdrawAmount').value || 0);
      const method = document.getElementById('payMethod').value;
      if(!amount || amount < CONFIG.MIN_WITHDRAW){ alert('সর্বনিম্ন উইথড্র: ' + CONFIG.MIN_WITHDRAW + '৳'); return; }
      if(amount > user.balance){ alert('আপনার ব্যালান্স পর্যাপ্ত নয়'); return; }

      // get account field
      let accVal = '';
      if(method === 'bank') accVal = document.getElementById('bankAcc')?.value || '';
      else if(method === 'other') accVal = document.getElementById('otherName')?.value || '';
      else accVal = document.getElementById('mobileNo')?.value || '';
      if(!accVal){ alert('পেমেন্ট মেথড অনুযায়ী অ্যাকাউন্ট/নাম পূরণ করুন'); return; }

      const requests = JSON.parse(localStorage.getItem(REQUESTS_KEY) || '[]');
      const req = {id: 'req_' + Date.now(), userId: user.id, method, account: accVal, amount, status:'pending', createdAt: new Date().toISOString()};
      requests.push(req);
      localStorage.setItem(REQUESTS_KEY, JSON.stringify(requests));

      // deduct immediately for demo (in real app admin approves first)
      user.balance = (user.balance || 0) - amount;
      saveUser(user);
      renderAll();
      alert('উইথড্র রিকোয়েস্ট পাঠানো হয়েছে (ডেমো)। অ্যাডমিন আপডেট করবে।');

      // If you want to notify admin via Telegram Bot, uncomment and configure BOT_TOKEN and ADMIN_CHAT_ID above and use this fetch
      /*
      fetch('https://api.telegram.org/bot' + CONFIG.BOT_TOKEN + '/sendMessage',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({chat_id: CONFIG.ADMIN_CHAT_ID, text: 'New withdraw request: ' + JSON.stringify(req)})
      })
      */
    });

    function renderProfile(){
      document.getElementById('profileName').innerText = user.first_name || 'অতিথি';
      document.getElementById('profileUsername').innerText = user.username ? ('@' + user.username) : '@username';
      document.getElementById('profileBalance').innerText = (user.balance || 0).toFixed(2) + '৳';
      document.getElementById('profileAds').innerText = user.adsWatchedTotal || 0;
      document.getElementById('profileRef').innerText = user.referrals || 0;

      // build referral link based on current host
      const base = window.location.origin + window.location.pathname;
      const refLink = base + '?ref=' + user.id;
      document.getElementById('refLink').value = refLink;
    }

    document.getElementById('copyRef').addEventListener('click', async ()=>{
      const txt = document.getElementById('refLink').value;
      try{ await navigator.clipboard.writeText(txt); alert('কপি হয়েছে'); }
      catch(e){ alert('কপি ব্যর্থ, ম্যানুয়ালি কপি করুন: ' + txt); }
    });

    /**********************
     * Navigation
     **********************/
    const pages = {home: 'homePage', earn:'earnPage', withdraw:'withdrawPage', profile:'profilePage'};
    function goto(page){
      Object.values(pages).forEach(id=>document.getElementById(id).classList.remove('active'));
      document.getElementById(pages[page]).classList.add('active');
      // render particular
      if(page === 'earn') renderEarn();
      if(page === 'withdraw') renderWithdraw();
      if(page === 'profile') renderProfile();
    }
    document.getElementById('navHome').addEventListener('click', ()=>goto('home'));
    document.getElementById('navEarn').addEventListener('click', ()=>goto('earn'));
    document.getElementById('navWithdraw').addEventListener('click', ()=>goto('withdraw'));
    document.getElementById('navProfile').addEventListener('click', ()=>goto('profile'));

    /**********************
     * Initial render
     **********************/
    tryTelegramUser();
    function renderAll(){ renderHeader(); renderSummary(); renderHome(); renderProfile(); }
    renderAll();

    // save a copy of this user's public profile by id too (so demo referral credit may work in same browser)
    localStorage.setItem(STORAGE_KEY + '_' + user.id, JSON.stringify(user));
  </script>

</body>
</html>
